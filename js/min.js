$(function(){function b(e,t,n){var r={};r.node=document.createElement("canvas");r.context=r.node.getContext("2d");r.node.width=t;r.node.height=n;e.appendChild(r.node);return r}function E(e,t,n,r){var i=b(e,t,n);s=$(i.node)[0];o=i.context;o.clearTo=function(e){w=t||document.getElementById("canvas").offsetWidth;h=n||document.getElementById("canvas").offsetWidth;o.fillStyle=e;o.fillRect(0,0,w,h)};o.fillCircle=function(e,t,n,r){this.fillStyle=r;this.beginPath();this.moveTo(e,t);this.arc(e,t,n,0,Math.PI*2,false);this.fill()};o.clearTo=function(e){o.fillStyle=e;o.fillRect(0,0,t,n)};o.clearTo(r||"#ffffff");L();$(i.node).css("z-index",v);$(i.node).attr("data-layer",v);v++;return s}function S(e){if(!u){return}$(".terrain").removeClass("active");$(".objet").removeClass("active");$("#textContent").val("");$("#textForm").show();m=$(".layers li.active").children(":first").attr("data-layer");$("#textForm").css("left",e.pageX-$("#canvas").position().left);$("#textForm").css("top",e.pageY-$("#canvas").position().top);$("#textForm").css("z-index",m+1)}function x(e){if(!u){return}if($(".objet").hasClass("active")){var t=$(".objet.active").find("img").attr("src");var n=$(".objet.active").find("img").attr("width");var r=$(".objet.active").find("img").attr("height")}else{var n=parseInt($("#diametre").val());if($("#bucket").hasClass("active")&&$(".terrain").hasClass("active")){n=g*2}var t=$(".terrain.active").find("img").attr("src");var r=n}if(isNaN(n)){n=50}var i=$("#carre").hasClass("active");if(typeof t==="undefined"){return null}var s=e.pageX-$("#canvas").position().left-n/2;var a=e.pageY-$("#canvas").position().top-r/2;var f=new Image;f.src=t;if(i===true&&!$(".objet").hasClass("active")){f.onload=function(){o.fillStyle=o.createPattern(f,"repeat");o.fillRect(s,a,n,n)}}else if($(".objet").hasClass("active")){f.onload=function(){o.drawImage(f,s+n/2,a+r/2,n,r)}}else{var l=o.createPattern(f,"repeat");o.fillStyle=l;o.fillCircle(s+n/2,a+r/2,n/2,l)}}function T(e){if(u){var r=parseInt($("#diametre").val());if(isNaN(r)){r=50}var i=$(".terrain.active").find("img").attr("src");if(i===""){return}var s=$("#colorpickerField1").val();if(s===""){s="000000"}var a=e.pageX-$("#canvas").position().left;var f=e.pageY-$("#canvas").position().top;var l="#"+s;o.fillCircle(a,f,r/2,l);o.beginPath();o.strokeStyle=l;o.lineWidth=r;o.lineJoin="round";o.moveTo(t,n);o.lineTo(a,f);o.closePath();o.stroke()}t=a;n=f}function N(e){if(u){var r=parseInt($("#diametre").val());if(isNaN(r)){r=50}var i=$("#colorpickerField1").val();if(i===""){i="000000"}var s=e.pageX-$("#canvas").position().left;var a=e.pageY-$("#canvas").position().top;var f="#"+i;o.beginPath();o.strokeStyle=f;o.setLineDash([r,0]);o.lineWidth=r;o.lineJoin="round";if(t!==null&&n!==null){o.moveTo(t,n)}o.lineTo(s,a);o.closePath();o.stroke();$("#tack").show();$("#tack").css("z-index",m+1);$("#tack").css("left",s);$("#tack").css("top",a-20)}t=s;n=a}function C(e){if(u){var t=$("#colorpickerField1").val();if(t===""){t="000000"}var n=e.pageX-$("#canvas").position().left;var s=e.pageY-$("#canvas").position().top;var a="#"+t;o.beginPath();o.strokeStyle=a;o.setLineDash([10,15]);o.lineWidth=2;if(r!==null&&i!==null){o.moveTo(r,i)}o.lineTo(n,s);o.closePath();o.stroke();$("#tack").show();$("#tack").css("z-index",m+1);$("#tack").css("left",n);$("#tack").css("top",s-20)}r=n;i=s}function k(e){if(!u){return}var t=parseInt($("#diametre").val());if(isNaN(t)){t=50}var n=$("#carre").hasClass("active");var r=e.pageX-$("#canvas").position().left;var i=e.pageY-$("#canvas").position().top;var s="#ffffff";if(n===true){o.fillStyle=s;o.fillRect(r-t/2,i-t/2,t,t)}else{o.fillCircle(r,i,t/2,s)}}function L(){if(typeof f[m]==="undefined"){f[m]=new Array}l=f[m].length;f[m][l]=l;if(typeof a[m]==="undefined"){a[m]=new Array}a[m][l]=s.toDataURL()}function A(){if(l>0){l--;var e=new Image;e.src=a[m][l];e.onload=function(){o.drawImage(e,0,0)}}else if(l===0&&m>0){o.clearRect(0,0,s.width,s.height)}}function O(){if(l<a[m].length-1){l=f[m][l+1];var e=new Image;e.src=a[m][l];e.onload=function(){o.drawImage(e,0,0)}}}var e=document.getElementById("canvas");var t,n,r,i,s,o;var u=false;var a=new Array;var f=new Array;var l=-1;var c=[{name:"ctrly",key:89},{name:"ctrlz",key:90}];var p=17;var d=false;var v=0;var m=0;var g=document.getElementById("canvas").offsetWidth-15;var y=document.getElementById("canvas").offsetWidth;$("#colorpickerField1").ColorPicker({onSubmit:function(e,t,n,r){$(r).val(t);$(r).ColorPickerHide()},onBeforeShow:function(){$(this).ColorPickerSetColor(this.value)},onChange:function(e,t,n){$("#colorpickerField1").val(t);$("#colorpickerField1").siblings().css("color","#"+t)}}).bind("keyup",function(){$(this).ColorPickerSetColor(this.value)});$(".colorpicker").css("z-index",1e4);$("#reset").click(function(){$("#canvas").children().remove();E(e,document.getElementById("canvas").offsetWidth-15,document.getElementById("canvas").offsetWidth,"#ffffff")});$(".terrain, .objet").click(function(){$("#textForm").hide();$("#tack").hide();$("#tack").css("left","");$("#tack").css("top","");$("#eraser, #pencil, .objet, #text, #line, #dash").removeClass("active")});$("#eraser, #pencil, #text, #line, #dash").click(function(){t=null;n=null;r=null;i=null;$("#textForm").hide();$("#tack").hide();$("#tack").css("left","");$("#tack").css("top","");$(".objet, .terrain").removeClass("active")});$("#add_layer").click(function(){$(".layers").prepend('<li><a data-layer="'+v+'" href="#"><i style="padding: 6px 0px;color:black;" class="fa fa-eye fa-lg pull-left hideLayer"></i> Calque '+v+' <i style="padding: 6px 12px;" class="fa fa-times fa-lg pull-right removeLayer"></i></a></li>');$(".layers li").removeClass("active");$(".layers li:first").addClass("active");m=$(".layers li.active").children(":first").attr("data-layer");E(e,$("canvas:first").width(),$("canvas:first").height(),"#ffffff");s=$('canvas[data-layer="'+m+'"]')[0];o=s.getContext("2d");o.clearRect(0,0,s.width,s.height)});$(document).on("click",".removeLayer",function(){var e=parseInt($(this).parent().attr("data-layer"));$(this).parent().parent().remove();$('canvas[data-layer="'+e+'"]').remove();$(".layers li:first").addClass("active");m=parseInt($(".layers li.active").children(":first").attr("data-layer"));s=$('canvas[data-layer="'+m+'"]')[0];o=s.getContext("2d");$('canvas[data-layer="'+m+'"]').css("z-index",m);return false});$(document).on("click",".layers li",function(){m=parseInt($(this).children(":first").attr("data-layer"));$(".layers li").removeClass("active");$(this).addClass("active");$("canvas").css("z-index",-1);$("#textForm").css("z-index",-1);$("#tack").css("z-index",-1);$('canvas[data-layer="'+m+'"]').css("z-index",m);s=$('canvas[data-layer="'+m+'"]')[0];o=s.getContext("2d")});$(document).on("click",".hideLayer",function(){var e=parseInt($(this).parent().attr("data-layer"));if($(this).css("color")==="rgb(0, 0, 0)"){$('canvas[data-layer="'+e+'"]').css("opacity",0);$(this).css("color","red")}else{$('canvas[data-layer="'+e+'"]').css("opacity",1);$(this).css("color","black")}return false});$("#export").click(function(){$("#exportContainer").children().remove();var e=document.getElementById("canvas").getElementsByTagName("canvas");var t=b(document.getElementById("exportContainer"),g,y);t.context.fillStyle="#ffffff";t.context.fillRect(0,0,g,y);for(key in e){if(typeof e[key]==="object"){t.context.drawImage(e[key].getContext("2d").canvas,0,0)}}var n=new Image;n.src=t.context.canvas.toDataURL("image/png");window.open(t.node.toDataURL("image/png"),"_blank")});$("#undo").click(function(){A()});$("#redo").click(function(){O()});$("#validText").click(function(){var e=$("#colorpickerField1").val();if(e===""){e="000000"}m=parseInt($(this).children(":first").attr("data-layer"));o.fillStyle="#"+e;o.font="16px Calibri";o.fillText($("#textContent").val(),$("#textForm").css("left").split("px")[0],$("#textForm").css("top").split("px")[0]);u=false;L();$("#textForm").hide();$("#textContent").val("")});$("#cancelText").click(function(){u=false;$("#textForm").hide();$("#textContent").val("")});$("#textForm").draggable({containment:"parent"});s=E(e,g,y,"#ffffff");$(document).on("vmousemove","canvas",function(e){e.preventDefault();var t=false;var n=false;if($("#eraser").hasClass("active")){t=true}else if($("#pencil").hasClass("active")){n=true}if($(".objet").hasClass("active")){return}if(t===true){k(e)}else if(n===true){T(e)}else{x(e)}});$(document).on("mouseover","canvas",function(e){if($("#line").hasClass("active")||$("#dash").hasClass("active")){$("canvas").css("cursor",'url("img/field_objects/thumbtack.png")'+0+" "+20+", pointer")}else{var t=$(".objet.active").find("img").attr("src");var n=$(".objet.active").find("img").attr("width");var r=$(".objet.active").find("img").attr("height");var i=-n/2;var s=-r/2;$("canvas").css("cursor",'url("'+t+'")'+i+" "+s+", pointer")}});$(document).on("vmousedown","canvas",function(e){if(e.which===3){return}if(t===null){t=e.pageX-$("#canvas").position().left}if(n===null){n=e.pageY-$("#canvas").position().top}u=true;var r=false;var i=false;var s=false;var o=false;var a=false;if($("#eraser").hasClass("active")){r=true}else if($("#pencil").hasClass("active")){i=true}else if($("#text").hasClass("active")){s=true}else if($("#line").hasClass("active")){o=true}else if($("#dash").hasClass("active")){a=true}if(r===true){k(e)}else if(i===true){T(e)}else if(s===true){S(e)}else if(o===true){N(e)}else if(a===true){C(e)}else{x(e)}});$(document).on("vmouseup","canvas",function(e){u=false;L()});$(document).keyup(function(e){if(e.which===p)d=false}).keydown(function(e){if(e.which===p)d=true;if(d===true){jQuery.each(c,function(t){if(c[t].key===e.which){if(c[t].key===89){O()}else if(c[t].key===90){A()}return}})}})})